name: Build Android Kernel

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex git gnupg gperf libncurses5-dev \
          libssl-dev libxml2-utils lzop openjdk-11-jdk python3 python3-pip \
          unzip zip zlib1g-dev

    - name: Clone toolchains
      run: |
        mkdir -p toolchain/gcc/linux-x86/aarch64/
        mkdir -p toolchain/clang/host/linux-x86/
        cd toolchain/gcc/linux-x86/aarch64/
        git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 --depth=1
        cd ../../../clang/host/linux-x86/
        cd ../../../
        curl -o clang-r383902.tar.gz https://android.googlesource.com/platform//prebuilts/clang/host/linux-x86/+archive/3857008389202edac32d57008bb8c99d2c957f9d/clang-r383902.tar.gz
        tar -xzf clang-r383902.tar.gz
        cd clang-r383902/
        export PATH=bin:$PATH
        cd ../../../
        

    - name: Make build script executable
      run: chmod +x build_kernel.sh
      
    - name: Clone kernel source
      if: ${{ !startsWith(github.repository, 'YourKernelRepoName') }}
      run: |
        git clone -b kernel https://github.com/Yenping0001/android_kernel_samsung_a32x.git kernel
        cd kernel  

    - name: Build kernel
      run: ./build_kernel.s
    - name: Upload build output
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: |
          out/
          *.zip
          *.img
