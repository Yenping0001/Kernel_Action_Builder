name: Build Android Kernel

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex git gnupg gperf libncurses5-dev \
          libssl-dev libxml2-utils lzop openjdk-11-jdk python3 python3-pip \
          unzip zip zlib1g-dev

     - name: Clone toolchains
      run: |
        mkdir -p toolchain/gcc/linux-x86/aarch64/
        mkdir -p toolchain/clang/host/linux-x86/
        cd toolchain/gcc/linux-x86/aarch64/
        git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 --depth=1
        cd ../../../clang/host/linux-x86/
        git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/clang-r383902 --depth=1
        cd ../../../../     

    - name: Clone kernel source (if separate)
      if: ${{ !startsWith(github.repository, 'android_kernel_samsung_a32x') }}
      run: |
        git clone -b kernel https://github.com/Yenping0001/android_kernel_samsung_a32x.git kernel
        cd kernel

    - name: Make build script executable
      run: |
        chmod +x build_kernel.sh

    - name: Build kernel
      run: |
        ./build_kernel.sh

    - name: Upload build output
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: |
          out/
          *.zip
          *.img
